---
title: "2020-penta"
---

## Packages

```{r pkgs}
#| message: false
library(tidyverse)
theme_set(theme_light())
library(mgcv)
library(tidygam)
```

## Read data

```{r eng-hist}
eng_hist <- read_csv("data/eng_hist.csv")

eng_count <- eng_hist %>%
  filter(Include == 1) %>%
  group_by(EnglishPeriod, TextId, Pentaset, Words) %>%
  count() %>%
  mutate(
    period = case_when(
      EnglishPeriod == "OE" ~ 1,
      EnglishPeriod == "ME" ~ 2,
      EnglishPeriod == "eModE" ~ 3,
      EnglishPeriod == "lModE" ~ 4
    ),
    EnglishPeriod = factor(EnglishPeriod, levels = c("OE", "ME", "eModE", "lModE")),
    Pentaset = as.factor(Pentaset),
    Author = sub("(-|\\.).*", "", TextId),
    TextId = as.factor(TextId),
    Author = as.factor(Author)
  )
```

```{r plot}
eng_count %>%
  ggplot(aes(period, n, colour = Pentaset)) +
  geom_jitter(alpha = 0.2) +
  facet_wrap(~ Pentaset)

eng_count %>%
  ggplot(aes(period, n/Words, colour = Pentaset)) +
  geom_jitter(alpha = 0.2) +
  facet_wrap(~ Pentaset)
```

## GAMs

```{r gam-1}
gam_1 <- bam(
  n ~
    s(period, by = Pentaset, k = 3) +
    s(Author, bs = "re") +
    offset(log(Words/100000)),
  data = eng_count,
  family = poisson
)
```

```{r}
predict_gam(
  gam_1, series = "period",
  values = c("Words" = 1e+5),
  exclude_terms = "s(Author)",
  length_out = 50, tran_fun = exp
) %>%
  plot(comparison = "Pentaset") +
  scale_color_brewer(type = "qual", palette = "Set1") +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  scale_x_continuous(labels = c("OE", "ME", "eModE", "lModE")) +
  labs(
    y = "PP count per 100k words" 
  )

ggsave("img/period-penta.png", width = 7, height = 5)
```
